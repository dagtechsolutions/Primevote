<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PrimeVote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="primevote.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Extra round green buttons (override Tailwind default) */
    .prime-btn {
      background: linear-gradient(90deg, #008000 20%, #38b000 100%) !important;
      color: #fff !important;
      border: none !important;
      font-weight: 600 !important;
      border-radius: 9999px !important;
      transition: background 0.2s, transform 0.1s;
      cursor: pointer;
      box-shadow: 0 1.5px 6px 0 rgba(56,176,0,0.08);
      padding: 0.6em 1.4em !important;
      margin-right: 0.4em !important;
      margin-top: 0.3em;
    }
    .prime-btn:hover {
      background: linear-gradient(90deg, #38b000 10%, #008000 100%) !important;
      transform: translateY(-2px) scale(1.04);
    }
    .toggle-on {
      background: linear-gradient(90deg, #38b000 10%, #008000 100%) !important;
    }
    .toggle-off {
      background: linear-gradient(90deg, #008000 10%, #38b000 100%) !important;
      opacity: 0.6;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
<header>
  <h1>PrimeVote</h1>
  <div id="vote-status" class="mt-2 text-lg"></div>
</header>
<main>
  <!-- LOGIN SECTION -->
  <section id="login-section" class="bg-white p-6 rounded-lg shadow mb-10">
    <h2>Login</h2>
    <form id="admin-login-form" class="mb-3 flex items-center space-x-2">
      <input type="password" id="admin-password-input" placeholder="Admin password" required>
      <button type="submit" class="prime-btn">Admin Login</button>
    </form>
    <form id="voter-login-form" class="flex items-center space-x-2">
      <input type="text" id="voter-id-input" placeholder="Enter your Voter ID" required>
      <button type="submit" class="prime-btn">Voter Login</button>
    </form>
    <div id="login-status" class="text-red-600 mt-2"></div>
  </section>

  <!-- ADMIN PANEL -->
  <section id="admin-section" class="bg-white p-6 rounded-lg shadow mb-10 hidden">
    <h2>Admin Panel</h2>
    <div class="mb-4 flex items-center space-x-2">
      <button id="toggle-voting-btn" class="prime-btn toggle-off" type="button">Open Voting</button>
      <span id="current-voting-state" class="font-semibold"></span>
    </div>
    <div class="mb-4">
      <h3 class="font-semibold mb-1">Bulk Upload Voter IDs</h3>
      <textarea id="voters-textarea" rows="3" placeholder="Paste 140 voter IDs, one per line"></textarea>
      <button id="upload-voters-btn" type="button" class="prime-btn">Upload Voters</button>
    </div>
    <div class="mb-4">
      <h3 class="font-semibold mb-1">Add Contestant</h3>
      <form id="add-contestant-form" class="space-y-2">
        <input type="text" id="contestant-name" placeholder="Name" required>
        <input type="text" id="contestant-position-key" placeholder="Position Key (e.g. president)" required>
        <input type="text" id="contestant-position-label" placeholder="Position Label (e.g. President)" required>
        <input type="text" id="contestant-description" placeholder="Description" required>
        <input type="file" id="contestant-photo" accept="image/*">
        <button type="submit" class="prime-btn">Add</button>
      </form>
      <div id="add-contestant-status" class="text-red-600 mt-2"></div>
    </div>
    <div>
      <h3 class="font-semibold mb-1">All Contestants</h3>
      <ul id="admin-contestant-list"></ul>
    </div>
    <div class="mt-4 text-sm text-gray-600">Note: Only admin can see this section.</div>
    <button id="admin-logout-btn" class="prime-btn mt-4" type="button">Logout</button>
  </section>

  <!-- VOTER PANEL -->
  <section id="voter-section" class="bg-white p-6 rounded-lg shadow mb-10 hidden">
    <h2>Voter Voting</h2>
    <div id="voter-status" class="mb-5"></div>
    <div>
      <h3 class="font-semibold mb-1">All Contestants</h3>
      <ul id="voter-contestant-list"></ul>
    </div>
    <form id="voting-panel" class="hidden">
      <div id="positions-list"></div>
      <button type="submit" class="prime-btn">Submit Votes</button>
    </form>
    <button id="voter-logout-btn" class="prime-btn mt-4" type="button">Logout</button>
  </section>

  <!-- RESULTS SECTION -->
  <section class="bg-white p-6 rounded-lg shadow">
    <h2>Live Results</h2>
    <div id="results"></div>
  </section>
</main>
<script>
document.addEventListener('DOMContentLoaded', function() {
  let isAdmin = false;
  let voterId = '';
  let voterVotes = {};

  // --- Helper for JSON fetch with error handling
  async function fetchJSON(url, options = {}) {
    const defaultHeaders = {'Content-Type':'application/json'};
    const mergedOptions = { ...options };
    if (mergedOptions.method && mergedOptions.method.toUpperCase() === 'POST' && !(mergedOptions.body instanceof FormData)) {
      mergedOptions.headers = { ...defaultHeaders, ...options.headers };
    }
    const res = await fetch(url, mergedOptions);
    // try-catch for non-JSON errors (e.g. 502 Bad Gateway)
    try {
      return await res.json();
    } catch {
      return {};
    }
  }

  // --- LOGIN LOGIC ---
  document.getElementById('admin-login-form').onsubmit = (e) => {
    e.preventDefault();
    const pwd = document.getElementById('admin-password-input').value;
    if (pwd === "admin2024") {
      isAdmin = true;
      voterId = '';
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('admin-section').classList.remove('hidden');
      document.getElementById('voter-section').classList.add('hidden');
      document.getElementById('login-status').textContent = '';
      refreshAdminContestants();
      refreshAllContestants(); // show in admin panel
      refreshVotingState();
      renderResults();
    } else {
      document.getElementById('login-status').textContent = "Invalid admin password!";
    }
  };

  document.getElementById('voter-login-form').onsubmit = async (e) => {
    e.preventDefault();
    voterId = document.getElementById('voter-id-input').value.trim();
    if (!voterId) return;
    try {
      const res = await fetchJSON('/api/voter-auth', {
        method: 'POST', 
        body: JSON.stringify({voterId})
      });
      if (res.error) {
        document.getElementById('login-status').textContent = "Invalid Voter ID!";
        return;
      }
      isAdmin = false;
      voterVotes = Object.fromEntries(Object.entries(res.votes||{}));
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      document.getElementById('voter-section').classList.remove('hidden');
      document.getElementById('voting-panel').classList.remove('hidden');
      document.getElementById('voter-status').textContent = "You are eligible to vote for open positions.";
      document.getElementById('login-status').textContent = '';
      renderVotingPanel();
      refreshAllContestants(); // show in voter panel
      renderResults();
    } catch {
      document.getElementById('login-status').textContent = "Login error";
    }
  };

  document.getElementById('admin-logout-btn').onclick = () => {
    isAdmin = false;
    document.getElementById('login-section').classList.remove('hidden');
    document.getElementById('admin-section').classList.add('hidden');
  };
  document.getElementById('voter-logout-btn').onclick = () => {
    voterId = '';
    voterVotes = {};
    document.getElementById('login-section').classList.remove('hidden');
    document.getElementById('voter-section').classList.add('hidden');
  };

  // --- ADMIN: BULK VOTER UPLOAD ---
  document.getElementById('upload-voters-btn').onclick = async () => {
    const lines = document.getElementById('voters-textarea').value.trim().split('\n').map(x=>x.trim()).filter(x=>x);
    if (lines.length !== 140) {
      alert("You must enter exactly 140 voter IDs (one per line).");
      return;
    }
    await fetchJSON(`/api/voters`, {
      method: 'POST',
      body: JSON.stringify({voterIds: lines})
    });
    alert("Voters uploaded!");
  };

  // --- ADMIN: ADD CONTESTANT ---
  document.getElementById('add-contestant-form').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('name', document.getElementById('contestant-name').value);
    formData.append('positionKey', document.getElementById('contestant-position-key').value);
    formData.append('positionLabel', document.getElementById('contestant-position-label').value);
    formData.append('description', document.getElementById('contestant-description').value);
    if (document.getElementById('contestant-photo').files[0])
      formData.append('photo', document.getElementById('contestant-photo').files[0]);
    try {
      const res = await fetch(`/api/contestants`, {
        method: 'POST', body: formData
      });
      if (!res.ok) {
        const err = await res.json();
        document.getElementById('add-contestant-status').textContent = err.error || "Error adding contestant";
      } else {
        document.getElementById('add-contestant-status').textContent = '';
        e.target.reset();
        refreshAdminContestants();
        refreshAllContestants(); // show update in both panels
        renderResults();
      }
    } catch (err) {
      document.getElementById('add-contestant-status').textContent = 'Network error';
    }
  };

  // --- TOGGLE VOTING STATE (as a true toggle button) ---
  async function refreshVotingState() {
    try {
      const res = await fetchJSON(`/api/voting-state`);
      const btn = document.getElementById('toggle-voting-btn');
      const stateText = document.getElementById('current-voting-state');
      const voteStatus = document.getElementById('vote-status');
      if (res && res.votingOpen) {
        btn.textContent = 'Close Voting';
        btn.classList.add('toggle-on');
        btn.classList.remove('toggle-off');
        stateText.textContent = 'Voting is OPEN';
        voteStatus.textContent = 'Voting is OPEN';
      } else {
        btn.textContent = 'Open Voting';
        btn.classList.add('toggle-off');
        btn.classList.remove('toggle-on');
        stateText.textContent = 'Voting is CLOSED';
        voteStatus.textContent = 'Voting is CLOSED';
      }
    } catch (err) {
      document.getElementById('current-voting-state').textContent = "Voting state unavailable";
      document.getElementById('vote-status').textContent = "Voting state unavailable";
    }
  }
  document.getElementById('toggle-voting-btn').onclick = async () => {
    try {
      const state = await fetchJSON(`/api/voting-state`);
      await fetchJSON(`/api/voting-state`, {
        method: 'POST',
        body: JSON.stringify({open: !(state && state.votingOpen)})
      });
      refreshVotingState();
    } catch {
      alert("Unable to toggle voting state.");
    }
  };

  // --- ADMIN: CONTESTANT LIST ---
  async function refreshAdminContestants() {
    try {
      const listEl = document.getElementById('admin-contestant-list');
      const contestants = await fetchJSON(`/api/contestants`);
      listEl.innerHTML = '';
      if (!contestants || !contestants.length) {
        listEl.innerHTML = '<li>No contestants found.</li>';
        return;
      }
      contestants.forEach(c => {
        let li = document.createElement('li');
        li.innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <img src="${c.photo || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover"/>
            <span>
              <b>${c.name}</b> (${c.positionLabel})<br>
              <span class="text-xs text-gray-500">${c.description||''}</span>
            </span>
          </div>
        `;
        listEl.appendChild(li);
      });
    } catch (err) {
      document.getElementById('admin-contestant-list').innerHTML = "<li>Error loading contestants</li>";
    }
  }

  // --- ALL CONTESTANTS (for both voter and admin) ---
  async function refreshAllContestants() {
    try {
      const res = await fetchJSON(`/api/contestants`);
      // ADMIN list (already handled above)
      // VOTER list
      const voterList = document.getElementById('voter-contestant-list');
      voterList.innerHTML = '';
      if (!res || !res.length) {
        voterList.innerHTML = '<li>No contestants found.</li>';
        return;
      }
      res.forEach(c => {
        let li = document.createElement('li');
        li.innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <img src="${c.photo || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover"/>
            <span>
              <b>${c.name}</b> (${c.positionLabel})<br>
              <span class="text-xs text-gray-500">${c.description||''}</span>
            </span>
          </div>
        `;
        voterList.appendChild(li);
      });
    } catch (err) {
      document.getElementById('voter-contestant-list').innerHTML = "<li>Error loading contestants</li>";
    }
  }

  // --- VOTER: VOTING PANEL ---
  async function renderVotingPanel() {
    try {
      const res = await fetchJSON(`/api/results`);
      const positionsList = document.getElementById('positions-list');
      positionsList.innerHTML = '';
      if (!res || typeof res !== "object" || Object.keys(res).length === 0) {
        positionsList.innerHTML = "<div>No positions found.</div>";
        return;
      }
      for (const [pkey, pdata] of Object.entries(res)) {
        const votedFor = voterVotes[pkey];
        let html = `<div class="mb-6"><div class="font-bold mb-1">${pdata.label}</div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">`;
        if (Array.isArray(pdata.list)) {
          pdata.list.forEach(cont => {
            html += `
              <label class="bg-gray-100 rounded p-3 flex items-center space-x-3 cursor-pointer">
                <input type="radio" name="vote_${pkey}" value="${cont._id}" ${votedFor==cont._id?'checked':''} ${votedFor?'disabled':''}>
                <img src="${cont.photo || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover"/>
                <span>
                  <span class="font-semibold">${cont.name}</span>
                  <span class="block text-xs text-gray-500">${cont.description||''}</span>
                </span>
              </label>
            `;
          });
        }
        html += `</div>`;
        if (votedFor) html += `<div class="text-green-700 mt-2">Voted</div>`;
        html += `</div>`;
        positionsList.innerHTML += html;
      }
    } catch (err) {
      document.getElementById('positions-list').innerHTML = "<div>Error loading voting panel.</div>";
    }
  }

  // --- VOTER: SUBMIT VOTES ---
  document.getElementById('voting-panel').onsubmit = async (e) => {
    e.preventDefault();
    const votes = {};
    Array.from(document.querySelectorAll('[name^="vote_"]')).forEach(inp => {
      if (inp.checked && !voterVotes[inp.name.slice(5)]) {
        votes[inp.name.slice(5)] = inp.value;
      }
    });
    if (Object.keys(votes).length === 0) {
      alert("You have already voted for all positions, or haven't selected any new choices.");
      return;
    }
    try {
      await fetchJSON(`/api/vote`, {
        method: 'POST', body: JSON.stringify({voterId, votes})
      });
      alert("Your votes have been recorded!");
      const res = await fetchJSON(`/api/voter-auth`, {
        method: 'POST', body: JSON.stringify({voterId})
      });
      voterVotes = Object.fromEntries(Object.entries(res.votes || {}));
      renderVotingPanel();
      renderResults();
    } catch (err) {
      alert("Unable to submit votes.");
    }
  };

  // --- LIVE RESULTS ---
  async function renderResults() {
    try {
      const res = await fetchJSON(`/api/results`);
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      if (!res || typeof res !== "object" || Object.keys(res).length === 0) {
        resultsDiv.innerHTML = "No results available.";
        return;
      }
      for (const [pkey, pdata] of Object.entries(res)) {
        resultsDiv.innerHTML += `<div class="mb-4"><div class="font-bold mb-1">${pdata.label}</div>`;
        const totalVotes = Array.isArray(pdata.list) ? pdata.list.reduce((a,c)=>a+c.votes,0) : 0;
        const displayTotalVotes = totalVotes === 0 ? 1 : totalVotes;
        if (Array.isArray(pdata.list)) {
          pdata.list.forEach(c => {
            const percent = (c.votes / displayTotalVotes) * 100;
            resultsDiv.innerHTML += `
              <div class="flex justify-between">
                <span>${c.name}</span>
                <span>${c.votes} votes (${percent.toFixed(1)}%)</span>
              </div>
              <div class="w-full bg-gray-200 h-2 rounded mb-1">
                <div class="bg-purple-600 h-2 rounded" style="width:${percent}%;"></div>
              </div>
            `;
          });
        }
        resultsDiv.innerHTML += `</div>`;
      }
    } catch (err) {
      document.getElementById('results').innerHTML = "Error loading results.";
    }
  }

  // Initial results and polling
  renderResults();
  setInterval(renderResults, 2500);

});
</script>
</body>
</html>
